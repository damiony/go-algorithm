## 二叉查找树

二叉查找树是最常用的一种二叉树，支持快速插入、删除、查找操作，理想情况下，时间复杂度是`O(logn)`。

但是，在频繁的插入、删除等动态更新过程中，会出现树的高度远大于`logn`的情况。这时二叉树会退化为链表，时间复杂度会退化到`O(N)`。

为了解决二叉查找树性能退化问题，需要用到平衡二叉树。

## 平衡二叉树

严格定义：二叉树中任意一个节点的左右子树高度相差不能大于1。

但是很多平衡二叉树并没有严格符合上面的定义。

实际上，所谓的平衡是指整棵树左右高度比较对称，树的高度相对来说就能低一些，插入、删除、查找等操作效率高一些。这是一种不严格的定义。

红黑树就是平衡二叉树的一种。

## 红黑树

简称`R-B Tree`。

红黑树规则：

- 根节点是黑色的。
- 每个叶子节点都是黑色的空节点。
- 任何相邻的节点都不能同时为红色。
- 每个节点到可达叶子节点的所有路径，都包含相同数目的黑色节点。

复杂度分析：

- 高度近似`log2n`。
- 插入、删除、查找操作的时间复杂度都是`O(logn)`。

和其他平衡二叉树的比较：

- `Treap`、`Splay Tree`大部分情况下操作效率很高，但是无法避免极端情况下时间复杂度的退化。
- `AVL`是一种高度平衡的二叉树，查找效率非常高，但是插入、删除需要做调整，所以比较费时。
- 红黑树是近似平衡，维护成本低，插入、删除、查找各种操作的性能都比较稳定。

## 左旋右旋

左旋右旋是红黑树中比较重要的两个操作，具体规则如图所示：

<img src="https://github.com/damiony/go-algorithm/blob/master/.images/red_black_1.jpg?raw=true" alt="左旋" style="zoom:40%;" />

## 插入操作的平衡

#### 1. 插入规则

插入的节点必须是红色；新插入的节点都是放在叶子节点上。

### 2. 调整说明

插入新节点时，可能会出现以下情况：

- 插入节点的父节点是黑色，这时什么都不用做。
- 插入节点是根节点，将它的颜色改为黑色就行。
- 其他情况。

如果出现其他情况，需要对红黑树进行调整，调整过程包含的操作为：左右旋转和改变颜色。

正在处理的节点为**关注节点**，最开始的关注节点是**新插入的节点**。

### 3. 调整操作

现在对每种情况做出调整。

**CASE1：关注节点是`a`，它的叔叔节点`d`是红色。**

1. 将关注节点`a`的父节点`b`、叔叔节点`d`的颜色都设置成黑色；
2. 将关注节点`a`的祖父节点`c`的颜色设置成红色；
3. 将关注节点变成`a`的祖父节点`c`；
4. 跳到`case2`或者`case3`。

<img src="G:\github\go-algorithm\.images\red_black_2.jpg" alt="case1" style="zoom:33%;" />

**CASE2：关注节点是`a`，它的叔叔节点`d`是黑色，关注节点`a`是其父节点`b`的右子节点。**

1. 关注节点变成`a`的父节点`b`；
2. 围绕节点`b`左旋；
3. 跳到case3。

<img src="G:\github\go-algorithm\.images\red_black_3.jpg" alt="case2" style="zoom:33%;" />

**CASE3：如果关注节点是`a`，它的叔叔节点`d`是黑色，关注节点`a`是其父节点`b`的左子节点。**

1. 围绕节点`a`的祖父节点`c`右旋；

2. 将父节点`b`、兄弟节点`c`的颜色互换。

3. 调整结束。

   <img src="G:\github\go-algorithm\.images\red_black_4.jpg" alt="case3" style="zoom:33%;" />

## 删除操作的平衡

### 1. 说明

调整操作分为两步：

- 针对删除节点初步调整，保证红黑树在一个节点被删除后，任然满足最后一条定义。即每个节点到可达子节点的所有路径，都包含相同数量黑色节点。
- 针对关注节点进行二次调整。

### 2. 初步调整

初步调整后，有的节点会被标记成两种颜色，“红-黑”或者“黑-黑”。如果被标记成“黑-黑”，那在计算黑色节点个数的时候，要算成两个黑色节点。

注意：如果一个节点既可以是红色，也可以是黑色，图中会用一半红一半黑标识；如果一个节点是“红-黑”或者“黑-黑”，图中会用左上角一个小黑点表示额外黑色。

**CASE1：如果被删除节点`a`只有一个子节点`b`。**

1. 删除节点`a`，并把节点`b`替换到节点`a`的位置。
2. 节点`a`只能是黑色，节点`b`也只能是红色，因为其他情况不满足红黑树定义。这种情况下，把节点`b`改成黑色。
3. 调整结束。

<img src="G:\github\go-algorithm\.images\red_black_5.jpg" alt="case1" style="zoom:33%;" />

**CASE2：如果要删除的节点`a`有两个非空子节点，并且它的后继节点就是节点`a`的右子节点`c`。**

1. 如果节点`a`的后继节点就是右子节点`c`，那右子节点`c`肯定没有左子树。这时删除节点`a`，并且将节点`c`替换到节点`a`的位置；
2. 把节点`c`的颜色设置为跟节点`a`相同的颜色；
3. 如果节点`c`是黑色，为了不违反最后一条定义，给节点c的右子节点`d`多加一个黑色。这时节点`d`就变成了“红-黑”或者“黑-黑”；
4. 将关注节点变成`d`。后续调整针对关注节点来做。

<img src="G:\github\go-algorithm\.images\red_black_6.jpg" alt="case2" style="zoom:33%;" />

**CASE3：如果要删除的节点`a`有两个非空子节点，并且它的后继节点不是右子节点。**

1. 删除后继节点`d`，过程参照**CASE 1**；
2. 将节点`a`替换成后继节点`d`；
3. 将节点`d`的颜色设置为跟节点`a`相同的颜色；为了不违反最后一条定义，将节点`d`的右子节点`c`多加一个黑色；
4. 关注节点变成`c`；后续调整针对关注节点来做。

<img src="G:\github\go-algorithm\.images\red_black_7.jpg" alt="case3" style="zoom:33%;" />

### 3. 二次调整

